<app-sidebar-layout #sidenav>

  <mat-toolbar color="primary" class="navbar">
    <mat-toolbar-row>
      <div fxLayout="row" fxLayoutAlign="space-between center" fxFlex="100">
        <div fxFlex="100" fxFlex.xs="20" fxFlex.sm="20" fxFlex.gt-sm="50" fxLayoutAlign="start center" fxLayoutGap="10px">
          <button mat-icon-button (click)="sidenav.toggle()">
            <mat-icon>menu</mat-icon>
          </button>
          <div class="logo" fxShow.lt-md="false" fxLayoutAlign="center center">
            <img src="../../../assets/logo.png">
          </div>
        </div>

        <div fxFlex="100" fxFlex.xs="80" fxFlex.sm="80" fxFlex.gt-sm="50" fxLayoutAlign="end center" fxLayoutGap="10px">
          <div class="search-field" fxLayoutAlign="start center">
            <mat-icon matPrefix matTooltip="Search for songs to add" matTooltipPosition="below" class="search-icon">search</mat-icon>
            <input name="searchTerm" matInput [formControl]="searchTerm" shouldPlaceholderFloat="false"
                   (ngModelChange)="setSearching(searchTerm.value.length > 0)" class="search-input">
            <button mat-icon-button (click)="searchTerm.setValue('')" class="close-button">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <!--<ng-container *ngIf="searching">-->
          <!---->
          <!--</ng-container>-->

          <mat-menu #deviceMenu="matMenu" yPosition="below" [overlapTrigger]="false">
            <button mat-menu-item *ngFor="let device of spotifyDevices" (click)="changeDevice(device)">
              {{ device.name }}
            </button>
          </mat-menu>

          <button *ngIf="party != null && account != null && party.type == 'SPOTIFY' && account.spotify != null"
                  matTooltip="{{getDeviceName(account.spotify.device)}}"
                  class="device-btn nav-btn"
                  mat-icon-button [matMenuTriggerFor]="deviceMenu">
            <mat-icon>speaker_phone</mat-icon>
          </button>

          <!--<button fxHide.lt-md="true" class="nav-btn" mat-icon-button (click)="join(party.id, true)"-->
                  <!--matTooltip="Re-connect to party"-->
                  <!--matTooltipPosition="below" class="nav-btn">-->
            <!--<mat-icon class="button-icon">refresh</mat-icon>-->
          <!--</button>-->

          <button fxHide.lt-md="true" class="nav-btn" mat-icon-button (click)="openSettings()"
                  matTooltip="Party settings" matTooltipPosition="below" *ngIf="canAdmin()">
            <mat-icon>settings</mat-icon>
          </button>

          <button fxHide.lt-md="true" class="nav-btn" mat-icon-button (click)="leave(false)" matTooltip="Stop party"
                  matTooltipPosition="below">
            <mat-icon>stop</mat-icon>
          </button>

          <button fxHide.lt-md="true" class="nav-btn" mat-icon-button color="warn" (click)="leave(true)"
                  matTooltip="Quit party" matTooltipPosition="below">
            <mat-icon>exit_to_app</mat-icon>
          </button>

          <mat-menu #mobileMenu="matMenu" yPosition="below" [overlapTrigger]="false">
            <!--<button mat-menu-item (click)="join(party.id, true)">-->
              <!--<mat-icon>refresh</mat-icon>-->
              <!--Reconnect to party-->
            <!--</button>-->
            <button mat-menu-item (click)="openSettings()">
              <mat-icon>settings</mat-icon>
              Settings
            </button>
            <button mat-menu-item (click)="leave(false)">
              <mat-icon>stop</mat-icon>
              Stop
            </button>
            <button mat-menu-item (click)="leave(true)">
              <mat-icon>exit_to_app</mat-icon>
              Quit party
            </button>
          </mat-menu>

          <button fxHide.gt-sm="true" class="nav-btn" mat-icon-button [matMenuTriggerFor]="mobileMenu">
            <i class="fa fa-ellipsis-h"></i>
          </button>

          <ng-container>
            <app-notification-menu></app-notification-menu>
            <app-account-menu></app-account-menu>
          </ng-container>
        </div>
      </div>
    </mat-toolbar-row>
  </mat-toolbar>

  <ng-template cdkPortal #searchTemplate="cdkPortal">
    <div class="search-overlay" fxLayout="column" *ngIf="searching">

      <div class="filter-container">
        <div style="float: right;">
          <button mat-icon-button class="heart-icon" [disabled]="searchingSongs"
                  (click)="setSearchFavourites(!searchingFavourites)">
            <mat-icon matTooltip="Search all" *ngIf="searchingFavourites">favorite</mat-icon>
            <mat-icon matTooltip="Only search in your favourites" *ngIf="!searchingFavourites">favorite_border
            </mat-icon>
          </button>
        </div>
      </div>

      <div fxFlex="100">
        <div class="search-spinner" *ngIf="searchingSongs" fxLayout="column" fxLayoutAlign="center center">
          <mat-progress-spinner
            class="in-progress"
            color="primary"
            mode="indeterminate">
          </mat-progress-spinner>
        </div>

        <div *ngIf="!searchingSongs">
          <div *ngIf="songs != null">
            <div fxLayout="row" fxLayoutAlign="row" fxLayoutWrap="true">
              <div class="song-card" *ngFor="let item of songs.items" fxFlex="50" fxFlex.xs="50" fxFlex.sm="33"
                   fxFlex.md="25" fxFlex.lg="14" fxFlex.xl="14">
                <app-song-card [party]="party"
                               [canDelete]="searchingFavourites"
                               (onDelete)="onFavouriteDelete($event)"
                               [song]="item"></app-song-card>
              </div>
            </div>

            <div fxLayout="row">
              <div *ngIf="!searchingSongs && songs.maxRecords >= songsLimit" fxFlex="100" fxFlex.gt-md="50">
                <mat-paginator [length]="songs.maxRecords"
                               [pageIndex]="songsPageNumber"
                               [pageSize]="songsLimit"
                               style="background: none;"
                               [pageSizeOptions]="pageSizeOptions"
                               (page)="onSongsPageEvent($event)">
                </mat-paginator>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>


  <div class="content" fxLayoutAlign="center">

    <div fxFlex="100" fxFlex.lt-md="98" fxFlex.gt-md="75">

      <div [style.padding]="isMobileView ? '10px' : '20px'">
        <mat-toolbar *ngIf="showNoSpotify" style="margin-bottom: 10px">
          <span>You need to link your Spotify Premium account to join this party, click
            <a class="link" [routerLink]="['/account']" [queryParams]="{tab: 'spotify'}">here</a> to get started.
          </span>
        </mat-toolbar>

        <div fxLayout="row" fxLayoutWrap="true" *ngIf="party != null">

          <div fxFlex.gt-md="75" fxFlex="100" style="padding: 10px">
            <mat-card id="app-now-playing-container" class="compact-card">
              <mat-card-header>
                <mat-card-title class="party-title-container">
                  <img *ngIf="party.type == 'YOUTUBE'" src="/assets/youtube.png" class="button-icon party-icon"
                       alt="youtube">
                  <img *ngIf="party.type == 'SPOTIFY'" src="/assets/spotify.png" class="button-icon party-icon"
                       alt="spotify">
                  <span>{{ party.name }}</span>
                </mat-card-title>
              </mat-card-header>
              <mat-card-content class="no-pad">
                <div class="now-playing-box" *ngIf="party.type == 'YOUTUBE'">
                  <div fxLayout="row" fxLayoutAlign="center">
                    <div *ngIf="queue != null" fxFlex="100">
                      <div fxLayout="row" fxLayoutWrap="true">
                        <div fxFlex="100" fxFlex.gt-sm="60">
                          <div class="youtube-player">
                            <app-youtube-player #youtubeFrame>
                            </app-youtube-player>
                          </div>
                        </div>

                        <div fxFlex="100" fxFlex.gt-sm="40">
                          <mat-list *ngIf="queue.nowPlaying != null">
                            <mat-list-item class="now-playing-list-item">
                              <mat-icon mat-list-icon>music_note</mat-icon>
                              <h4 mat-line [innerHTML]="sanitize(queue.nowPlaying.title)"></h4>
                              <p mat-line [innerHTML]="sanitize(queue.nowPlaying.artist)"></p>
                            </mat-list-item>
                            <mat-list-item class="now-playing-list-item" *ngIf="queue.nowPlaying.member != null">
                              <mat-icon mat-list-icon>person</mat-icon>
                              <h4 mat-line>Requested by {{ queue.nowPlaying.member.displayName }}</h4>
                            </mat-list-item>
                            <mat-list-item class="now-playing-list-item">
                              <mat-icon mat-list-icon>av_timer</mat-icon>
                              <div mat-line>
                                <mat-progress-bar
                                  color="primary"
                                  mode="determinate"
                                  [value]="progress">
                                </mat-progress-bar>
                              </div>
                            </mat-list-item>
                            <mat-list-item class="now-playing-list-item">
                              <button mat-icon-button class="heart-icon" [disabled]="favouriting"
                                      (click)="onSetFavourited(queue.nowPlaying)">
                                <ng-container *ngIf="isFavourited(queue.nowPlaying.songId)">
                                  <mat-icon>favorite</mat-icon>
                                  Remove song from favourites
                                </ng-container>
                                <ng-container *ngIf="!isFavourited(queue.nowPlaying.songId)">
                                  <mat-icon matTooltip="Add to favourites">favorite_border</mat-icon>
                                  Add song to favourites
                                </ng-container>
                              </button>
                            </mat-list-item>
                            <!--<mat-list-item class="now-playing-list-item">-->
                              <!--<button class="skip-btn" mat-button color="accent"-->
                                                     <!--(click)="vote(queue.nowPlaying, false, true)">-->
                                <!--<mat-icon class="button-icon">skip_next</mat-icon>-->
                                <!--Vote to skip-->
                              <!--</button>-->
                            <!--</mat-list-item>-->
                            <!--<mat-list-item class="skip-msg-item now-playing-list-item">-->
                              <!--<p mat-line class="skip-msg">{{getRemainingToSkipMessage()}}</p>-->
                            <!--</mat-list-item>-->
                            <!-- TODO: Re-enable -->
                          </mat-list>

                          <div *ngIf="queue == null || queue.nowPlaying == null">
                            <div fxLayout="row" fxLayoutAlign="center center">
                              <h3>Nothing is currently playing</h3>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="party.type != 'YOUTUBE'" class="now-playing-box">
                  <div fxLayout="row" fxLayoutAlign="center">
                    <div *ngIf="queue != null" fxFlex="100">
                      <div fxLayout="row" fxLayoutWrap="true">
                        <div class="now-playing-thumbnail"
                             [style.background-image]="getArtistThumbnail(queue.nowPlaying, true)"
                             fxFlex.gt-sm="60"
                             fxFlex="100"
                             *ngIf="party.type != 'YOUTUBE'">
                        </div>
                        <div fxFlex.gt-sm="40" fxFlex="100">
                          <mat-list *ngIf="queue.nowPlaying != null">
                            <mat-list-item>
                              <mat-icon mat-list-icon>music_note</mat-icon>
                              <h4 mat-line [innerHTML]="sanitize(queue.nowPlaying.title)"></h4>
                              <p mat-line [innerHTML]="sanitize(queue.nowPlaying.artist)"></p>
                            </mat-list-item>
                            <mat-list-item *ngIf="queue.nowPlaying.member != null">
                              <mat-icon mat-list-icon>person</mat-icon>
                              <h4 mat-line>Requested by {{ queue.nowPlaying.member.displayName }}</h4>
                            </mat-list-item>
                            <mat-list-item>
                              <mat-icon mat-list-icon>av_timer</mat-icon>
                              <div mat-line>
                                <mat-progress-bar
                                  color="primary"
                                  mode="determinate"
                                  [value]="progress">
                                </mat-progress-bar>
                              </div>
                            </mat-list-item>
                            <mat-list-item class="now-playing-list-item">
                              <button mat-icon-button class="heart-icon" [disabled]="favouriting"
                                      (click)="onSetFavourited(queue.nowPlaying)">
                                <ng-container *ngIf="isFavourited(queue.nowPlaying.songId)">
                                  <mat-icon>favorite</mat-icon>
                                  Remove song from favourites
                                </ng-container>
                                <ng-container *ngIf="!isFavourited(queue.nowPlaying.songId)">
                                  <mat-icon matTooltip="Add to favourites">favorite_border</mat-icon>
                                  Add song to favourites
                                </ng-container>
                              </button>
                            </mat-list-item>
                            <!--<mat-list-item>-->
                              <!--<button class="skip-btn" mat-button color="accent"-->
                                      <!--(click)="vote(queue.nowPlaying, false, true)">-->
                                <!--<mat-icon class="button-icon">skip_next</mat-icon>-->
                                <!--Vote to skip-->
                              <!--</button>-->
                            <!--</mat-list-item>-->
                            <!--<mat-list-item class="skip-msg-item">-->
                              <!--<p mat-line class="skip-msg">{{getRemainingToSkipMessage()}}</p>-->
                            <!--</mat-list-item>-->
                            <!-- TODO: re-enable -->
                          </mat-list>
                        </div>
                      </div>
                      <div *ngIf="queue == null || queue.nowPlaying == null">
                        <div fxLayout="column" fxLayoutAlign="center center">
                          <h3>Nothing is currently playing</h3>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div fxFlex.gt-md="25" fxFlex="100" style="padding: 10px" *ngIf="viewChat">
            <app-party-chat [party]="party" [partyMembers]="partyMembers"></app-party-chat>
          </div>
        </div>

        <div fxLayout="row">
          <div [@opacityInOut] fxFlex="100" style="padding: 10px;">

            <mat-card>
              <mat-card-content>
                <mat-tab-group>
                  <mat-tab label="Queue">
                    <app-party-queue [favourites]="favourites" [favouriting]="favouriting"
                                     (onFavourite)="onSetFavourited($event)"
                                     [party]="party" [queue]="queue"></app-party-queue>
                  </mat-tab>
                  <mat-tab label="History">
                    <app-party-history [favourites]="favourites" [favouriting]="favouriting"
                                     (onFavourite)="onSetFavourited($event)"
                                     [party]="party" [history]="history"></app-party-history>
                  </mat-tab>
                  <mat-tab label="Settings">
                    <app-party-settings [party]="party"></app-party-settings>
                  </mat-tab>
                </mat-tab-group>
              </mat-card-content>
            </mat-card>

          </div>
        </div>
      </div>
    </div>
  </div>

</app-sidebar-layout>
